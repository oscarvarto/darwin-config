#!/bin/bash

# Complete Kitty Setup - Full automation of kitty configuration
# This script automates all the manual setup we did for kitty

set -e

echo "üê± Starting complete Kitty setup..."
echo "This will configure fonts, terminfo, themes, and all kitty settings"
echo ""

# Check if kitty is installed
if ! command -v kitty &> /dev/null; then
    echo "‚ùå Error: kitty is not installed"
    echo ""
    echo "Please install kitty first:"
    echo "  brew install --cask kitty"
    echo ""
    echo "Or add 'kitty' to your homebrew casks in modules/casks.nix and rebuild"
    exit 1
fi

echo "‚úÖ Kitty is installed"

# Check if MonoLisa Variable font is available
echo ""
echo "üî§ Checking font availability..."
if fc-list | grep -q "MonoLisaVariable Nerd Font"; then
    echo "‚úÖ MonoLisaVariable Nerd Font is available"
    font_status="available"
else
    echo "‚ö†Ô∏è  MonoLisaVariable Nerd Font not found"
    echo "   The configuration will fall back to system fonts"
    font_status="missing"
fi

# Setup terminfo
echo ""
echo "üìã Setting up terminfo..."
terminfo_output=$(setup-kitty-terminfo 2>&1)
terminfo_status=$?
echo "$terminfo_output"

if [[ $terminfo_status -eq 0 ]]; then
    if echo "$terminfo_output" | grep -q "already complete"; then
        echo "‚è≠Ô∏è  Terminfo setup skipped (already working)"
    else
        echo "‚úÖ Terminfo setup completed"
    fi
else
    echo "‚ùå Terminfo setup failed"
    exit 1
fi

# Setup themes
echo ""
echo "üé® Setting up themes..."
theme_output=$(setup-kitty-themes 2>&1)
theme_status=$?
echo "$theme_output"

if [[ $theme_status -eq 0 ]]; then
    if echo "$theme_output" | grep -q "already complete"; then
        echo "‚è≠Ô∏è  Theme setup skipped (already configured)"
    else
        echo "‚úÖ Theme setup completed"
    fi
else
    echo "‚ö†Ô∏è  Theme setup completed with warnings"
fi

# Verify configuration
echo ""
echo "üîç Verifying configuration..."

config_file="$HOME/.config/kitty/kitty.conf"
if [[ -f "$config_file" ]]; then
    echo "‚úÖ Configuration file exists: $config_file"

    # Check key settings
    if grep -q "MonoLisaVariable Nerd Font" "$config_file"; then
        echo "‚úÖ Font configuration found"
    fi

    if grep -q "font_size 18" "$config_file"; then
        echo "‚úÖ Font size configured"
    fi

    if grep -q "disable_ligatures never" "$config_file"; then
        echo "‚úÖ Ligatures enabled"
    fi

    if grep -q "current-theme.conf" "$config_file"; then
        echo "‚úÖ Theme configuration found"
    fi
else
    echo "‚ùå Configuration file missing"
    exit 1
fi

# Summary
echo ""
echo "üéâ Kitty setup complete!"
echo ""
echo "üìã Summary:"
echo "  ‚Ä¢ Configuration: ~/.config/kitty/kitty.conf"
echo "  ‚Ä¢ Font: MonoLisaVariable Nerd Font, size 18 ($font_status)"
echo "  ‚Ä¢ Terminfo: xterm-kitty installed"
echo "  ‚Ä¢ Default theme: Catppuccin Latte"
echo "  ‚Ä¢ Ligatures: Enabled"
echo ""
echo "üõ†Ô∏è  Available commands:"
echo "  ‚Ä¢ test-kitty-font      - Test font rendering"
echo "  ‚Ä¢ kitty-light          - Switch to light theme"
echo "  ‚Ä¢ kitty-dark           - Switch to dark theme"
echo "  ‚Ä¢ kitty-theme-switcher - Auto theme switching"
echo ""
echo "üìù Next steps:"
echo "  1. Open a new kitty terminal window"
echo "  2. Run 'test-kitty-font' to verify everything works"
echo "  3. Use 'kitty +kitten themes' for interactive theme selection"

if [[ "$font_status" == "missing" ]]; then
    echo ""
    echo "‚ö†Ô∏è  To get the best experience, install MonoLisaVariable Nerd Font:"
    echo "   Download from: https://www.monolisa.dev/"
    echo "   Or install a Nerd Font variant and update the config"
fi