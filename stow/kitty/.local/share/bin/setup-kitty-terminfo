#!/bin/bash

# Setup Kitty Terminfo - Install terminfo for proper kitty terminal support
# This script handles the terminfo installation that we did manually

set -e

echo "ğŸ± Setting up Kitty terminfo..."

# Check if kitty is installed
if ! command -v kitty &> /dev/null; then
    echo "âŒ Error: kitty is not installed or not in PATH"
    echo "   Please install kitty via Homebrew: brew install --cask kitty"
    exit 1
fi

# Find kitty installation
KITTY_APP="/Applications/kitty.app"
HOMEBREW_KITTY="/opt/homebrew/bin/kitty"

if [[ -d "$KITTY_APP" ]]; then
    TERMINFO_SOURCE="$KITTY_APP/Contents/Resources/kitty/terminfo/kitty.terminfo"
    echo "ğŸ“ Found kitty app at: $KITTY_APP"
elif [[ -x "$HOMEBREW_KITTY" ]]; then
    echo "ğŸ“ Found homebrew kitty at: $HOMEBREW_KITTY"
    # For homebrew kitty, we'll use a different approach
    TERMINFO_SOURCE=""
else
    echo "âŒ Error: Could not find kitty installation"
    exit 1
fi

# Check if terminfo is already properly installed
echo "ğŸ” Checking if xterm-kitty terminfo is already available..."
if infocmp xterm-kitty &> /dev/null; then
    echo "âœ… xterm-kitty terminfo is already installed"

    # Test basic functionality
    colors=$(TERM=xterm-kitty tput colors 2>/dev/null || echo "unknown")
    if [[ "$colors" =~ ^[0-9]+$ ]] && [[ "$colors" -ge 256 ]]; then
        echo "âœ… Terminfo is working correctly ($colors colors)"

        # Test emacsclient compatibility if available
        if command -v emacsclient &> /dev/null; then
            if TERM=xterm-kitty emacsclient --version &> /dev/null; then
                echo "âœ… emacsclient compatibility verified"
                echo "ğŸ‰ Terminfo setup is already complete and working!"
                exit 0
            else
                echo "âš ï¸  emacsclient compatibility issue detected, reinstalling..."
            fi
        else
            echo "ğŸ‰ Terminfo setup is already complete!"
            exit 0
        fi
    else
        echo "âš ï¸  Terminfo exists but seems broken, reinstalling..."
    fi
else
    echo "âŒ xterm-kitty terminfo not found, installing..."
fi

# Create terminfo directory if it doesn't exist
mkdir -p ~/.terminfo

if [[ -n "$TERMINFO_SOURCE" && -f "$TERMINFO_SOURCE" ]]; then
    echo "ğŸ“¥ Installing terminfo from kitty app bundle..."
    # Install using tic command
    tic -x -o ~/.terminfo "$TERMINFO_SOURCE"
    echo "âœ… Terminfo installed successfully"
else
    echo "âš ï¸  Could not find terminfo source, attempting alternative method..."

    # Alternative: try to extract terminfo from running kitty
    if command -v infocmp &> /dev/null; then
        # Check if xterm-kitty already exists
        if infocmp xterm-kitty &> /dev/null; then
            echo "âœ… xterm-kitty terminfo already available"
        else
            echo "âŒ Could not install terminfo automatically"
            echo "   Please run this script from within a kitty terminal"
            exit 1
        fi
    fi
fi

# Verify terminfo installation
echo "ğŸ” Verifying terminfo installation..."
if infocmp xterm-kitty &> /dev/null; then
    echo "âœ… xterm-kitty terminfo is working correctly"

    # Test basic capabilities
    colors=$(TERM=xterm-kitty tput colors 2>/dev/null || echo "unknown")
    echo "ğŸ¨ Terminal supports $colors colors"

    # Test emacsclient compatibility
    if command -v emacsclient &> /dev/null; then
        if TERM=xterm-kitty emacsclient --version &> /dev/null; then
            echo "âœ… emacsclient compatibility verified"
        else
            echo "âš ï¸  emacsclient compatibility issues detected"
        fi
    fi
else
    echo "âŒ Terminfo verification failed"
    exit 1
fi

echo ""
echo "ğŸ‰ Kitty terminfo setup complete!"
echo ""
echo "Next steps:"
echo "  â€¢ Open a new kitty terminal"
echo "  â€¢ Run 'test-kitty-font' to verify font configuration"
echo "  â€¢ Run 'kitty +kitten themes' to set up themes"